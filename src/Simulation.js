// App.js – komplette funktionierende Version
import React, { useState, useMemo } from "react";
import { Bar } from "react-chartjs-2";

import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Tooltip,
  Legend,
} from "chart.js";

import { MapContainer, TileLayer, Polyline } from "react-leaflet";
import "leaflet/dist/leaflet.css";
import { Marker, Popup } from "react-leaflet";
import L from "leaflet";

ChartJS.register(CategoryScale, LinearScale, BarElement, Tooltip, Legend);

// ------------------ Schwarzes Punkt-Icon ------------------
const blackDotIcon = new L.DivIcon({
  className: "", // keine zusätzliche CSS-Klasse
  html: `<div style="
    width: 12px;
    height: 12px;
    background-color: black;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 2px rgba(0,0,0,0.5);
  "></div>`,
  iconSize: [12, 12],
  iconAnchor: [6, 6], // mittig setzen
  popupAnchor: [0, -6],
});

// ------------------ Deine echten Routen (aus GeoJSON, in [lat, lon]) ------------------
const bremerhavenCenter = [53.548, 8.58];

const leftRoute = [
  [53.53492, 8.5978],
  [53.53503, 8.59777],
  [53.53513, 8.59774],
  [53.5354, 8.59766],
  [53.53553, 8.59761],
  [53.53565, 8.59758],
  [53.53571, 8.59756],
  [53.53582, 8.59753],
  [53.53586, 8.59752],
  [53.53603, 8.59747],
  [53.53601, 8.59728],
  [53.53599, 8.59715],
  [53.53599, 8.5971],
  [53.53598, 8.59704],
  [53.5359, 8.59656],
  [53.53581, 8.59597],
  [53.53575, 8.5956],
  [53.53572, 8.59544],
  [53.53566, 8.59508],
  [53.53541, 8.59356],
  [53.53528, 8.59279],
  [53.53524, 8.59257],
  [53.53493, 8.59094],
  [53.53483, 8.59032],
  [53.5348, 8.59004],
  [53.5348, 8.58995],
  [53.5348, 8.58985],
  [53.53482, 8.58964],
  [53.53484, 8.58944],
  [53.53484, 8.58931],
  [53.53484, 8.5891],
  [53.53485, 8.58901],
  [53.53485, 8.58895],
  [53.53488, 8.58889],
  [53.53492, 8.58884],
  [53.535, 8.58879],
  [53.53516, 8.58875],
  [53.53533, 8.58867],
  [53.53546, 8.58862],
  [53.53572, 8.58846],
  [53.53585, 8.58835],
  [53.53596, 8.58827],
  [53.53604, 8.58818],
  [53.5361, 8.58811],
  [53.53624, 8.5879],
  [53.53637, 8.58764],
  [53.53643, 8.58754],
  [53.53665, 8.58713],
  [53.53681, 8.58685],
  [53.53696, 8.58657],
  [53.53699, 8.58653],
  [53.53703, 8.58644],
  [53.53708, 8.58632],
  [53.5372, 8.5861],
  [53.53725, 8.58599],
  [53.53732, 8.58586],
  [53.53754, 8.58545],
  [53.53784, 8.58498],
  [53.53789, 8.58489],
  [53.53803, 8.58467],
  [53.53834, 8.58418],
  [53.53871, 8.58361],
  [53.53882, 8.58343],
  [53.53891, 8.58326],
  [53.53901, 8.58305],
  [53.53908, 8.58286],
  [53.53926, 8.5824],
  [53.53935, 8.58211],
  [53.53961, 8.58124],
  [53.53963, 8.58119],
  [53.53967, 8.58106],
  [53.53973, 8.58085],
  [53.53984, 8.58048],
  [53.53995, 8.58022],
  [53.54003, 8.58007],
  [53.54018, 8.5798],
  [53.54039, 8.57955],
  [53.54062, 8.57933],
  [53.54075, 8.5792],
  [53.54099, 8.57897],
  [53.54123, 8.57875],
  [53.5416, 8.57839],
  [53.54261, 8.57742],
  [53.54269, 8.57734],
  [53.54277, 8.57727],
  [53.54279, 8.57725],
  [53.54284, 8.57721],
  [53.5429, 8.57715],
  [53.54307, 8.57697],
  [53.54324, 8.57679],
  [53.544, 8.57605],
  [53.54404, 8.57602],
  [53.54406, 8.576],
  [53.54415, 8.57589],
  [53.54421, 8.57582],
  [53.54443, 8.57561],
  [53.54457, 8.57548],
  [53.54469, 8.57537],
  [53.54481, 8.57532],
  [53.54493, 8.57525],
  [53.54507, 8.57517],
  [53.54521, 8.57508],
  [53.54553, 8.57491],
  [53.54573, 8.57474],
  [53.54599, 8.57447],
  [53.54638, 8.57405],
  [53.54648, 8.57394],
  [53.54665, 8.57377],
  [53.54684, 8.57356],
  [53.5469, 8.5735],
  [53.54698, 8.57342],
  [53.54706, 8.57363],
  [53.54718, 8.57397],
  [53.54727, 8.57406],
  [53.54738, 8.57437],
  [53.54747, 8.57466],
  [53.54758, 8.57498],
  [53.5476, 8.57503],
  [53.54765, 8.57518],
  [53.5477, 8.57535],
  [53.54772, 8.5754],
  [53.54784, 8.57578],
  [53.54795, 8.57608],
  [53.54824, 8.57691],
  [53.54833, 8.57719],
  [53.54834, 8.5772],
  [53.54838, 8.57734],
  [53.54845, 8.57752],
  [53.54857, 8.5779],
  [53.54869, 8.57827],
  [53.54874, 8.57867],
  [53.54885, 8.57899],
  [53.54887, 8.57904],
  [53.54889, 8.57912],
  [53.54891, 8.57918],
  [53.54899, 8.57944],
  [53.54905, 8.57961],
  [53.54913, 8.57963],
  [53.54921, 8.57967],
  [53.54936, 8.57974],
  [53.54955, 8.57984],
  [53.54975, 8.57993],
  [53.54985, 8.57994],
  [53.55006, 8.58005],
  [53.55017, 8.58012],
  [53.55025, 8.58017],
  [53.55056, 8.58036],
  [53.55075, 8.58049],
  [53.55093, 8.58062],
  [53.5511, 8.58074],
  [53.55114, 8.58078],
  [53.55123, 8.58084],
  [53.55131, 8.5809],
  [53.55148, 8.58073],
  [53.55155, 8.58063],
  [53.55161, 8.58057],
  [53.55194, 8.58026],
  [53.5521, 8.58012],
  [53.55217, 8.58006],
  [53.55231, 8.57994],
  [53.55243, 8.57989],
  [53.55251, 8.57982],
  [53.55253, 8.57979],
  [53.55276, 8.57957],
  [53.55281, 8.57952],
  [53.55298, 8.57931],
  [53.55304, 8.57921],
  [53.55314, 8.57905],
  [53.5532, 8.57885],
  [53.55346, 8.57834],
  [53.55394, 8.57742],
  [53.55417, 8.57713],
  [53.55435, 8.57691],
  [53.55486, 8.57643],
  [53.55557, 8.57581],
  [53.55644, 8.57504],
  [53.5568, 8.57479],
  [53.55721, 8.57451],
  [53.55741, 8.57437],
];

const rightRoute = [
  [53.53492, 8.5978],
  [53.53503, 8.59777],
  [53.53513, 8.59774],
  [53.5354, 8.59766],
  [53.53553, 8.59761],
  [53.53565, 8.59758],
  [53.53571, 8.59756],
  [53.53582, 8.59753],
  [53.53586, 8.59752],
  [53.53603, 8.59747],
  [53.53611, 8.59745],
  [53.53668, 8.5973],
  [53.53808, 8.59688],
  [53.53817, 8.59685],
  [53.53823, 8.59681],
  [53.53825, 8.5968],
  [53.53826, 8.5968],
  [53.53831, 8.59675],
  [53.53838, 8.59669],
  [53.53843, 8.59662],
  [53.53846, 8.59657],
  [53.53849, 8.59653],
  [53.53855, 8.59643],
  [53.53864, 8.59623],
  [53.53873, 8.59602],
  [53.53892, 8.59549],
  [53.53899, 8.59524],
  [53.53921, 8.59423],
  [53.53931, 8.5936],
  [53.53935, 8.59338],
  [53.53935, 8.59338],
  [53.53939, 8.59268],
  [53.53945, 8.59238],
  [53.53949, 8.59216],
  [53.53951, 8.59205],
  [53.53961, 8.59169],
  [53.53977, 8.59087],
  [53.53981, 8.59062],
  [53.53983, 8.59049],
  [53.53983, 8.59049],
  [53.53986, 8.59031],
  [53.53988, 8.59016],
  [53.53989, 8.59009],
  [53.53991, 8.59002],
  [53.53991, 8.58984],
  [53.53991, 8.58909],
  [53.53991, 8.58901],
  [53.53991, 8.58881],
  [53.53991, 8.58856],
  [53.53991, 8.58811],
  [53.53991, 8.58769],
  [53.53991, 8.58762],
  [53.53991, 8.58755],
  [53.53992, 8.58736],
  [53.53994, 8.5873],
  [53.53997, 8.5872],
  [53.53999, 8.58715],
  [53.54002, 8.58699],
  [53.54005, 8.58682],
  [53.54009, 8.58663],
  [53.54014, 8.58646],
  [53.54015, 8.5864],
  [53.54016, 8.58639],
  [53.54029, 8.58585],
  [53.5404, 8.58544],
  [53.54046, 8.58521],
  [53.54048, 8.58516],
  [53.54052, 8.58499],
  [53.54052, 8.58499],
  [53.54062, 8.58505],
  [53.54064, 8.58507],
  [53.54068, 8.5851],
  [53.54097, 8.58529],
  [53.54116, 8.58543],
  [53.54131, 8.58553],
  [53.54136, 8.58556],
  [53.54157, 8.58566],
  [53.54185, 8.5858],
  [53.54189, 8.58582],
  [53.54202, 8.58587],
  [53.54215, 8.58591],
  [53.54228, 8.58593],
  [53.54237, 8.58593],
  [53.54249, 8.58591],
  [53.54262, 8.58585],
  [53.54274, 8.58577],
  [53.54294, 8.58555],
  [53.54308, 8.58533],
  [53.54337, 8.58475],
  [53.5435, 8.58448],
  [53.54361, 8.58425],
  [53.54378, 8.5839],
  [53.54384, 8.58374],
  [53.54397, 8.58338],
  [53.54406, 8.58306],
  [53.54413, 8.58278],
  [53.54424, 8.58229],
  [53.54429, 8.5821],
  [53.54441, 8.58167],
  [53.54445, 8.58155],
  [53.54454, 8.58135],
  [53.54459, 8.58124],
  [53.5447, 8.58106],
  [53.54494, 8.58074],
  [53.54528, 8.5804],
  [53.54577, 8.57998],
  [53.54589, 8.57993],
  [53.54592, 8.57992],
  [53.54667, 8.57984],
  [53.54673, 8.57984],
  [53.54697, 8.57981],
  [53.54745, 8.57976],
  [53.54761, 8.57975],
  [53.54786, 8.57973],
  [53.54818, 8.57969],
  [53.54839, 8.57967],
  [53.54852, 8.57966],
  [53.54885, 8.57962],
  [53.54891, 8.57961],
  [53.54894, 8.57961],
  [53.54905, 8.57961],
  [53.54905, 8.57961],
  [53.54913, 8.57963],
  [53.54921, 8.57967],
  [53.54936, 8.57974],
  [53.54955, 8.57984],
  [53.54975, 8.57993],
  [53.54985, 8.57994],
  [53.55006, 8.58005],
  [53.55017, 8.58012],
  [53.55025, 8.58017],
  [53.55056, 8.58036],
  [53.55075, 8.58049],
  [53.55093, 8.58062],
  [53.5511, 8.58074],
  [53.55114, 8.58078],
  [53.55123, 8.58084],
  [53.55123, 8.58084],
  [53.55131, 8.5809],
  [53.55148, 8.58073],
  [53.55155, 8.58063],
  [53.55161, 8.58057],
  [53.55194, 8.58026],
  [53.5521, 8.58012],
  [53.55217, 8.58006],
  [53.55231, 8.57994],
  [53.55243, 8.57989],
  [53.55251, 8.57982],
  [53.55253, 8.57979],
  [53.55276, 8.57957],
  [53.55281, 8.57952],
  [53.55298, 8.57931],
  [53.55304, 8.57921],
  [53.55314, 8.57905],
  [53.5532, 8.57885],
  [53.55346, 8.57834],
  [53.55394, 8.57742],
  [53.55417, 8.57713],
  [53.55435, 8.57691],
  [53.55486, 8.57643],
  [53.55557, 8.57581],
  [53.55644, 8.57504],
  [53.5568, 8.57479],
  [53.55721, 8.57451],
  [53.55743, 8.57436],
  [53.55744, 8.57435],
];

const newRoute = [
  [53.5429, 8.57715],
  [53.54292, 8.5772],
  [53.54317, 8.57794],
  [53.54319, 8.578],
  [53.5435, 8.57888],
  [53.54351, 8.57893],
  [53.54358, 8.57913],
  [53.54364, 8.57929],
  [53.54365, 8.57934],
  [53.54384, 8.57988],
  [53.54388, 8.57999],
  [53.54389, 8.58003],
  [53.54403, 8.58042],
  [53.54406, 8.58051],
  [53.54408, 8.58056],
  [53.54416, 8.5808],
  [53.54425, 8.58108],
  [53.54425, 8.58108],
  [53.54443, 8.58124],
  [53.54447, 8.58128],
  [53.54454, 8.58135],
  [53.54454, 8.58135],
];

// ------------------------------------------

export default function Simulation() {
  const LEFT_TOTAL = 500;
  const RIGHT_TOTAL = 400;
  const [extraRoadOn, setExtraRoadOn] = useState(true);
  const [newRoadUsers, setNewRoadUsers] = useState(200);
  const calcTimes = (extraOn, newUsers) => {
    const leftUsingNew = extraOn ? newUsers : 0;
    const leftRemaining = LEFT_TOTAL - leftUsingNew;
    const right = RIGHT_TOTAL;
    const baseLeft = 220;
    const baseRight = 240;
    const baseNew = 80;
    const addLeft = 2 * (leftRemaining / 100);
    const addRight = 2 * (right / 100);
    const addNew = 4 * (leftUsingNew / 100);
    const timeLeft = baseLeft + addLeft;
    const timeRight = baseRight + addRight;
    const timeNew = baseNew + addNew;
    const meanWithout =
      (LEFT_TOTAL * (baseLeft + 2 * (LEFT_TOTAL / 100)) +
        right * (baseRight + 2 * (right / 100))) /
      (LEFT_TOTAL + right);
    const totalVehicles = LEFT_TOTAL + right;
    const sumTimesWith =
      leftRemaining * timeLeft + leftUsingNew * timeNew + right * timeRight;
    const meanWith = sumTimesWith / totalVehicles;
    return {
      timeLeft: Number(timeLeft.toFixed(1)),
      timeRight: Number(timeRight.toFixed(1)),
      timeNew: Number(timeNew.toFixed(1)),
      meanWithout: Number(meanWithout.toFixed(1)),
      meanWith: Number(meanWith.toFixed(1)),
    };
  };

  const times = useMemo(
    () => calcTimes(extraRoadOn, newRoadUsers),
    [extraRoadOn, newRoadUsers]
  );

  const displayedMean = extraRoadOn ? times.meanWith : times.meanWithout;

  return (
    <div
      style={{
        display: "flex",
        height: "100vh",
        fontFamily: "Arial, sans-serif",
      }}
    >
      {/* Linker Bereich */}
      <div
        style={{
          width: 360,
          padding: 16,
          background: "#f7fafc",
          borderRight: "1px solid #e2e8f0",
        }}
      >
        {/* Anzeige */}
        <div
          style={{
            background: "#fff",
            padding: 12,
            borderRadius: 8,
            marginBottom: 16,
          }}
        >
          <div style={{ fontSize: 12, color: "#555" }}>Mittlere Reisezeit</div>
          <div style={{ fontSize: 36, fontWeight: 700 }}>{displayedMean}s</div>
          <div style={{ fontSize: 12, color: "#777" }}>
            aktuelle Einstellung: {extraRoadOn ? "mit Zusatz" : "ohne Zusatz"}
          </div>
        </div>

        {/* Steuerung */}
        <div
          style={{
            background: "#fff",
            padding: 12,
            borderRadius: 8,
            marginBottom: 16,
          }}
        >
          <label style={{ display: "flex", gap: 8 }}>
            <input
              type="checkbox"
              checked={extraRoadOn}
              onChange={(e) => setExtraRoadOn(e.target.checked)}
            />
            Zusätzliche Straße aktivieren
          </label>

          <div style={{ marginTop: 12 }}>
            <label>Linke Autos auf neuer Straße: {newRoadUsers}</label>
            <input
              type="range"
              min={50}
              max={350}
              value={newRoadUsers}
              onChange={(e) => setNewRoadUsers(Number(e.target.value))}
              style={{ width: "100%", marginTop: 8 }}
            />
          </div>

          <div style={{ fontSize: 12, marginTop: 6, color: "#666" }}>
            Links gesamt: 500 – Rechts: 400
          </div>
        </div>

        {/* EIN Balkendiagramm */}
        <div
          style={{
            background: "#fff",
            padding: 12,
            borderRadius: 8,
            marginBottom: 12,
          }}
        >
          <div style={{ marginBottom: 8, fontSize: 14 }}>
            Vergleich der mittleren Reisezeiten
          </div>
          <div style={{ height: 240 }}>
            <Bar
              data={{
                labels: ["Ohne Zusatz", "Mit Zusatz"],
                datasets: [
                  {
                    label: "Mittlere Reisezeit (s)",
                    data: [times.meanWithout, times.meanWith],
                    backgroundColor: ["#4A90E2", "#E94E4E"],
                  },
                ],
              }}
              options={{
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true },
                },
              }}
            />
          </div>
        </div>

        <div style={{ fontSize: 12, color: "#555" }}>
          Hinweis: Das Modell ist vereinfacht und demonstriert nur das Prinzip.
        </div>
      </div>

      {/* Rechte Seite: Karte */}
      <div style={{ flex: 1, padding: 20 }}>
        <MapContainer
          center={bremerhavenCenter}
          zoom={14}
          style={{ width: "100%", height: "100%", borderRadius: 8 }}
        >
          <TileLayer
            attribution="&copy; OpenStreetMap contributors"
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />

          {/* Linke Route */}
          <Polyline positions={leftRoute} color="blue" weight={5} />

          {/* Rechte Route */}
          <Polyline positions={rightRoute} color="green" weight={5} />
          <Marker position={rightRoute[0]} icon={blackDotIcon}>
            <Popup>Start</Popup>
          </Marker>
          <Marker
            position={rightRoute[rightRoute.length - 1]}
            icon={blackDotIcon}
          >
            <Popup>Ziel</Popup>
          </Marker>

          {/* Neue Straße */}
          {extraRoadOn && (
            <>
              <Polyline positions={newRoute} color="red" weight={5} />
            </>
          )}
        </MapContainer>
      </div>
    </div>
  );
}

